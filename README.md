# Vue Dirty Guard SDKï¼ˆå›¢é˜Ÿæ¨å¹¿ç‰ˆï¼‰

> **ä¸€å¥è¯å®šä½**ï¼š
> Vue Dirty Guard æ˜¯ä¸€ä¸ª**åº”ç”¨å±‚çš„â€œæœªæäº¤å˜æ›´ä¿æŠ¤æœºåˆ¶â€**ï¼Œç”¨äºç»Ÿä¸€è§£å†³ã€Œè¡¨å• / å¼¹çª— / è·¯ç”± / æµè§ˆå™¨å…³é—­ã€åœºæ™¯ä¸‹çš„**æœªä¿å­˜é€€å‡ºæç¤ºã€è‡ªåŠ¨ä¿å­˜ã€å†²çªå¤„ç†**é—®é¢˜ã€‚

---

## ä¸€ã€æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ª SDKï¼Ÿ

### 1ï¸âƒ£ çœŸå®ç—›ç‚¹ï¼ˆä½ ä¸€å®šè§è¿‡ï¼‰

* è¡¨å•å†™ä¸€åŠï¼Œç‚¹äº†è¿”å›ï¼Œæ•°æ®æ²¡äº†
* å¤š Tab / å¤šå¼¹çª—ï¼Œè°è¯¥æ‹¦æˆªï¼Ÿ
* æ¯ä¸ªé¡µé¢éƒ½è‡ªå·±å†™ `onBeforeRouteLeave`
* è‡ªåŠ¨ä¿å­˜æˆåŠŸäº†ï¼Œä½† Guard è¿˜åœ¨æ‹¦
* åç«¯ç‰ˆæœ¬å†²çªï¼Œå‰ç«¯çŠ¶æ€ä¹±äº†

ğŸ‘‰ **æœ¬è´¨é—®é¢˜ï¼šæˆ‘ä»¬ç¼ºå°‘ä¸€ä¸ªâ€œç»Ÿä¸€çš„å˜æ›´æäº¤ä¿æŠ¤æœºåˆ¶â€**ã€‚

---

## äºŒã€è®¾è®¡åŸåˆ™ï¼ˆéå¸¸é‡è¦ï¼‰

1. **è¿™æ˜¯åº”ç”¨å±‚èƒ½åŠ›ï¼Œä¸æ˜¯ UI èƒ½åŠ›**
2. SDK ä¸å…³å¿ƒä½ ç”¨ä»€ä¹ˆè¡¨å•åº“ / UI åº“
3. åªæŠ½è±¡â€œæ˜¯å¦å…è®¸ç¦»å¼€â€
4. å’Œ DDD / ä¹è§‚é” / è‡ªåŠ¨ä¿å­˜å¤©ç„¶å…¼å®¹

---

## ä¸‰ã€æ ¸å¿ƒæ¦‚å¿µï¼ˆç»Ÿä¸€å›¢é˜Ÿè¯­è¨€ï¼‰

### Dirty Adapterï¼ˆè„æ•°æ®é€‚é…å™¨ï¼‰

```ts
interface DirtyAdapter {
  id: string
  isDirty(): boolean
  reset(): void
  description?: string
}
```

> **ä»»ä½•ä¸€ä¸ªé¡µé¢ / è¡¨å• / å¼¹çª—ï¼Œåªè¦å®ç°è¿™ä¸ªæ¥å£ï¼Œå°±èƒ½è¢«ç»Ÿä¸€ç®¡ç†ã€‚**

---

### Dirty Guardï¼ˆç»Ÿä¸€å®ˆå«ï¼‰

```ts
dirtyGuard.hasDirty()      // æ˜¯å¦å­˜åœ¨æœªæäº¤å˜æ›´
dirtyGuard.resetAll()     // æäº¤ / æ”¾å¼ƒåç»Ÿä¸€é‡ç½®
dirtyGuard.getDirtyAdapters()
```

---

## å››ã€æœ€æ ‡å‡†çš„ä½¿ç”¨æ–¹å¼ï¼ˆæ¨èï¼‰

### 1ï¸âƒ£ é¡µé¢ä¸­æ³¨å†Œ Dirty Adapter

```ts
const adapter = {
  id: 'customer-edit',
  isDirty: () => !isEqual(form, snapshot.value),
  reset: () => snapshot.value = cloneDeep(form),
  description: 'å®¢æˆ·ä¿¡æ¯'
}

onMounted(() => dirtyGuard.register(adapter))
onUnmounted(() => dirtyGuard.unregister(adapter.id))
```

---

### 2ï¸âƒ£ è·¯ç”±ç»Ÿä¸€æ‹¦æˆªï¼ˆåªå†™ä¸€æ¬¡ï¼‰

```ts
router.beforeEach(() => {
  if (!dirtyGuard.hasDirty()) return true
  return confirm('å†…å®¹æœªä¿å­˜ï¼Œæ˜¯å¦ç¦»å¼€ï¼Ÿ')
})
```

---

### 3ï¸âƒ£ æµè§ˆå™¨åˆ·æ–° / å…³é—­ä¿æŠ¤

```ts
window.addEventListener('beforeunload', e => {
  if (!dirtyGuard.hasDirty()) return
  e.preventDefault()
  e.returnValue = ''
})
```

---

## äº”ã€Element Plus é›†æˆè§„èŒƒï¼ˆå›¢é˜Ÿå¿…è¯»ï¼‰

### ElDialog æœªä¿å­˜å…³é—­æ‹¦æˆª

```vue
<el-dialog :before-close="handleBeforeClose" />
```

```ts
const handleBeforeClose = useElDialogDirtyGuard(() => {
  visible.value = false
})
```

> **ç¦æ­¢åœ¨ä¸šåŠ¡ä»£ç é‡Œç›´æ¥å†™ confirm**ï¼Œç»Ÿä¸€ä½¿ç”¨ Guard æä¾›çš„èƒ½åŠ›ã€‚

---

## å…­ã€è‡ªåŠ¨ä¿å­˜ï¼ˆAuto Saveï¼‰è®¾è®¡è§„èŒƒ

### çŠ¶æ€æ¨¡å‹ï¼ˆç»Ÿä¸€ï¼‰

```text
Pristine â†’ Dirty â†’ AutoSaving â†’ Saved
                     â†“
                  Failed
```

### æ¨èäº¤äº’

* è‡ªåŠ¨ä¿å­˜è¿›è¡Œä¸­ï¼š

  * é¡µé¢å³ä¸Šè§’ï¼š`æ­£åœ¨ä¿å­˜...`
* è‡ªåŠ¨ä¿å­˜æˆåŠŸï¼š

  * é™é»˜æˆåŠŸï¼ˆä¸è¦ toastï¼‰
* è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼š

  * æ˜ç¡®æç¤º + ä¿æŒ Dirty

---

## ä¸ƒã€ç‰ˆæœ¬å†²çªï¼ˆä¹è§‚é”ï¼‰UX è§„èŒƒï¼ˆéå¸¸é‡è¦ï¼‰

### å†²çªå‘ç”Ÿæ—¶ï¼š

```text
ä½ çš„ä¿®æ”¹åŸºäºæ—§ç‰ˆæœ¬
æœåŠ¡å™¨å·²æœ‰æ›´æ–°
```

### æ ‡å‡†å¤„ç†å¼¹çª—

**æ ‡é¢˜**ï¼šå†…å®¹å†²çªæç¤º

**æ­£æ–‡**ï¼š

> å½“å‰å†…å®¹å·²è¢«ä»–äººä¿®æ”¹ï¼Œä½ çš„ä¿®æ”¹å°šæœªæäº¤ã€‚

**æ“ä½œ**ï¼š

* ğŸ” åˆ·æ–°æ•°æ®ï¼ˆæ”¾å¼ƒæœ¬åœ°ä¿®æ”¹ï¼‰
* ğŸ“ æ‰‹åŠ¨åˆå¹¶ï¼ˆä¿ç•™å½“å‰é¡µé¢ï¼‰

> â— å†²çªçŠ¶æ€ä¸‹ **Dirty Guard å¿…é¡»ç»§ç»­æ‹¦æˆªç¦»å¼€**

---

## å…«ã€Demo é¡¹ç›®è¯´æ˜ï¼ˆVue3 + Element Plusï¼‰

### Demo ç›®æ ‡

* å±•ç¤º Dirty Guard çš„**å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**
* è®©æ–°äºº 10 åˆ†é’Ÿç†è§£ç”¨æ³•

---

### Demo é¡µé¢ç»“æ„

```text
/pages
 â”œâ”€â”€ CustomerEdit.vue      # ä¸»è¡¨å•ï¼ˆDirtyï¼‰
 â”œâ”€â”€ OrderDialog.vue       # å­å¼¹çª—ï¼ˆDirtyï¼‰
 â””â”€â”€ AutoSaveBadge.vue     # è‡ªåŠ¨ä¿å­˜çŠ¶æ€å±•ç¤º
```

---

### Demo åœºæ™¯è¦†ç›–

1. ä¿®æ”¹è¡¨å• â†’ è·¯ç”±è·³è½¬æ‹¦æˆª
2. ä¿®æ”¹è¡¨å• â†’ å…³é—­ Dialog æ‹¦æˆª
3. è‡ªåŠ¨ä¿å­˜æˆåŠŸ â†’ å¯ç›´æ¥ç¦»å¼€
4. è‡ªåŠ¨ä¿å­˜å¤±è´¥ â†’ ç»§ç»­æ‹¦æˆª
5. æ¨¡æ‹Ÿç‰ˆæœ¬å†²çª â†’ å†²çªå¼¹çª—

---

## ä¹ã€å›¢é˜Ÿåä½œçº¦å®šï¼ˆéå¸¸å…³é”®ï¼‰

### âœ… æ¨è

* æ‰€æœ‰ç¼–è¾‘å‹é¡µé¢ **å¿…é¡»æ³¨å†Œ Dirty Adapter**
* æ‰€æœ‰å…³é—­è¡Œä¸º **å¿…é¡»èµ° Guard**
* è‡ªåŠ¨ä¿å­˜æˆåŠŸ **å¿…é¡» reset dirty**

### âŒ ç¦æ­¢

* é¡µé¢ç§è‡ªå†™ `window.confirm`
* ä¿å­˜æˆåŠŸä¸ reset
* å†²çªçŠ¶æ€æ”¾è¡Œè·¯ç”±

---

## åã€ä¸€å¥è¯æ€»ç»“ï¼ˆå¯¹å¤–ç»Ÿä¸€å£å¾„ï¼‰

> **Dirty Guard ä¸æ˜¯â€œè¡¨å•æŠ€å·§â€ï¼Œè€Œæ˜¯å‰ç«¯åº”ç”¨å±‚çš„ã€Œå˜æ›´æäº¤ä¿æŠ¤æœºåˆ¶ã€**

å®ƒè®©ï¼š

* ç”¨æˆ·ä¸ä¸¢æ•°æ®
* ä»£ç ä¸é‡å¤
* å¤æ‚é¡µé¢å¯æ§

---

## åä¸€ã€ä¸‹ä¸€æ­¥ï¼ˆå¯é€‰æ¼”è¿›ï¼‰

* å­—æ®µçº§ Diff å±•ç¤º
* è‡ªåŠ¨ä¿å­˜é¢‘ç‡ç­–ç•¥
* ä¸æƒé™ç³»ç»Ÿè”åŠ¨
* ä¸åç«¯å®¡è®¡æ—¥å¿—å¯¹é½

---

> **å¦‚æœä½ åœ¨å†™ä¸€ä¸ªä¼šâ€œä¿®æ”¹æ•°æ®â€çš„é¡µé¢ï¼Œå´æ²¡æœ‰ç”¨ Dirty Guardï¼Œé‚£å°±æ˜¯ä¸€ä¸ª Bugã€‚**
